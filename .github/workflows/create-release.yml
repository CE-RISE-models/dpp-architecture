name: Create Release from Tag

on:
    push:
        tags:
            - "[0-9][0-9][0-9][0-9].[0-9][0-9]" # Matches year.month tags like 2025.11
            - "[0-9][0-9][0-9][0-9].[0-9][0-9]-*" # Matches pre-release tags like 2025.11-beta

jobs:
    create-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write # Required for creating releases

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch all history for changelog generation

            - name: Extract tag name
              id: tag
              run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

            - name: Check if release exists
              id: check_release
              run: |
                  if gh release view "${{ steps.tag.outputs.TAG_NAME }}" >/dev/null 2>&1; then
                    echo "EXISTS=true" >> $GITHUB_OUTPUT
                  else
                    echo "EXISTS=false" >> $GITHUB_OUTPUT
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Generate Release Notes
              id: notes
              if: steps.check_release.outputs.EXISTS == 'false'
              run: |
                  cat << 'EOF' > release_notes.md
                  ## CE-RISE DPP & DMP Architecture ${{ steps.tag.outputs.TAG_NAME }}

                  This release is automatically mirrored from [Codeberg](https://codeberg.org/CE-RISE-models/dp-architecture).

                  ### üìö Documentation

                  The full documentation website is available at:
                  - [CE-RISE DPP & DMP Architecture Documentation](https://ce-rise-models.codeberg.page/dp-architecture/)

                  ### üìã Repository Contents

                  This repository contains the source files for the CE-RISE Digital Product and Material Passport (DPP & DMP) data model architecture documentation, including:
                  - Architecture overview and layered structure
                  - Component specifications and relationships
                  - Implementation roadmap
                  - Modular approach and design principles

                  ### üîó Related Resources

                  - [CE-RISE Project](https://ce-rise.eu/)
                  - [Main repository on Codeberg](https://codeberg.org/CE-RISE-models/dp-architecture)

                  ### üìÑ Citation

                  Please cite this work using the metadata in CITATION.cff or the DOI provided by Zenodo once available.

                  ### üìù License

                  Licensed under [Creative Commons Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)](https://creativecommons.org/licenses/by-nc/4.0/)

                  ---

                  **Note**: This is a mirror repository for Zenodo integration. For issues and contributions, please visit the [main repository on Codeberg](https://codeberg.org/CE-RISE-models/dpp-architecture).
                  EOF

            - name: Create GitHub Release
              if: steps.check_release.outputs.EXISTS == 'false'
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.tag.outputs.TAG_NAME }}
                  name: DPP Architecture ${{ steps.tag.outputs.TAG_NAME }}
                  body_path: release_notes.md
                  draft: false
                  prerelease: ${{ contains(steps.tag.outputs.TAG_NAME, '-') }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
